<!DOCTYPE html>
<html>
<head>
<title>README.md</title>
<meta http-equiv="Content-type" content="text/html;charset=UTF-8">

<style>
/* https://github.com/microsoft/vscode/blob/master/extensions/markdown-language-features/media/markdown.css */
/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/

body {
	font-family: var(--vscode-markdown-font-family, -apple-system, BlinkMacSystemFont, "Segoe WPC", "Segoe UI", "Ubuntu", "Droid Sans", sans-serif);
	font-size: var(--vscode-markdown-font-size, 14px);
	padding: 0 26px;
	line-height: var(--vscode-markdown-line-height, 22px);
	word-wrap: break-word;
}

#code-csp-warning {
	position: fixed;
	top: 0;
	right: 0;
	color: white;
	margin: 16px;
	text-align: center;
	font-size: 12px;
	font-family: sans-serif;
	background-color:#444444;
	cursor: pointer;
	padding: 6px;
	box-shadow: 1px 1px 1px rgba(0,0,0,.25);
}

#code-csp-warning:hover {
	text-decoration: none;
	background-color:#007acc;
	box-shadow: 2px 2px 2px rgba(0,0,0,.25);
}

body.scrollBeyondLastLine {
	margin-bottom: calc(100vh - 22px);
}

body.showEditorSelection .code-line {
	position: relative;
}

body.showEditorSelection .code-active-line:before,
body.showEditorSelection .code-line:hover:before {
	content: "";
	display: block;
	position: absolute;
	top: 0;
	left: -12px;
	height: 100%;
}

body.showEditorSelection li.code-active-line:before,
body.showEditorSelection li.code-line:hover:before {
	left: -30px;
}

.vscode-light.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(0, 0, 0, 0.15);
}

.vscode-light.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(0, 0, 0, 0.40);
}

.vscode-light.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

.vscode-dark.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(255, 255, 255, 0.4);
}

.vscode-dark.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(255, 255, 255, 0.60);
}

.vscode-dark.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

.vscode-high-contrast.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(255, 160, 0, 0.7);
}

.vscode-high-contrast.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(255, 160, 0, 1);
}

.vscode-high-contrast.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

img {
	max-width: 100%;
	max-height: 100%;
}

a {
	text-decoration: none;
}

a:hover {
	text-decoration: underline;
}

a:focus,
input:focus,
select:focus,
textarea:focus {
	outline: 1px solid -webkit-focus-ring-color;
	outline-offset: -1px;
}

hr {
	border: 0;
	height: 2px;
	border-bottom: 2px solid;
}

h1 {
	padding-bottom: 0.3em;
	line-height: 1.2;
	border-bottom-width: 1px;
	border-bottom-style: solid;
}

h1, h2, h3 {
	font-weight: normal;
}

table {
	border-collapse: collapse;
}

table > thead > tr > th {
	text-align: left;
	border-bottom: 1px solid;
}

table > thead > tr > th,
table > thead > tr > td,
table > tbody > tr > th,
table > tbody > tr > td {
	padding: 5px 10px;
}

table > tbody > tr + tr > td {
	border-top: 1px solid;
}

blockquote {
	margin: 0 7px 0 5px;
	padding: 0 16px 0 10px;
	border-left-width: 5px;
	border-left-style: solid;
}

code {
	font-family: Menlo, Monaco, Consolas, "Droid Sans Mono", "Courier New", monospace, "Droid Sans Fallback";
	font-size: 1em;
	line-height: 1.357em;
}

body.wordWrap pre {
	white-space: pre-wrap;
}

pre:not(.hljs),
pre.hljs code > div {
	padding: 16px;
	border-radius: 3px;
	overflow: auto;
}

pre code {
	color: var(--vscode-editor-foreground);
	tab-size: 4;
}

/** Theming */

.vscode-light pre {
	background-color: rgba(220, 220, 220, 0.4);
}

.vscode-dark pre {
	background-color: rgba(10, 10, 10, 0.4);
}

.vscode-high-contrast pre {
	background-color: rgb(0, 0, 0);
}

.vscode-high-contrast h1 {
	border-color: rgb(0, 0, 0);
}

.vscode-light table > thead > tr > th {
	border-color: rgba(0, 0, 0, 0.69);
}

.vscode-dark table > thead > tr > th {
	border-color: rgba(255, 255, 255, 0.69);
}

.vscode-light h1,
.vscode-light hr,
.vscode-light table > tbody > tr + tr > td {
	border-color: rgba(0, 0, 0, 0.18);
}

.vscode-dark h1,
.vscode-dark hr,
.vscode-dark table > tbody > tr + tr > td {
	border-color: rgba(255, 255, 255, 0.18);
}

</style>

<style>
/* Tomorrow Theme */
/* http://jmblog.github.com/color-themes-for-google-code-highlightjs */
/* Original theme - https://github.com/chriskempson/tomorrow-theme */

/* Tomorrow Comment */
.hljs-comment,
.hljs-quote {
	color: #8e908c;
}

/* Tomorrow Red */
.hljs-variable,
.hljs-template-variable,
.hljs-tag,
.hljs-name,
.hljs-selector-id,
.hljs-selector-class,
.hljs-regexp,
.hljs-deletion {
	color: #c82829;
}

/* Tomorrow Orange */
.hljs-number,
.hljs-built_in,
.hljs-builtin-name,
.hljs-literal,
.hljs-type,
.hljs-params,
.hljs-meta,
.hljs-link {
	color: #f5871f;
}

/* Tomorrow Yellow */
.hljs-attribute {
	color: #eab700;
}

/* Tomorrow Green */
.hljs-string,
.hljs-symbol,
.hljs-bullet,
.hljs-addition {
	color: #718c00;
}

/* Tomorrow Blue */
.hljs-title,
.hljs-section {
	color: #4271ae;
}

/* Tomorrow Purple */
.hljs-keyword,
.hljs-selector-tag {
	color: #8959a8;
}

.hljs {
	display: block;
	overflow-x: auto;
	color: #4d4d4c;
	padding: 0.5em;
}

.hljs-emphasis {
	font-style: italic;
}

.hljs-strong {
	font-weight: bold;
}
</style>

<style>
/*
 * Markdown PDF CSS
 */

 body {
	font-family: -apple-system, BlinkMacSystemFont, "Segoe WPC", "Segoe UI", "Ubuntu", "Droid Sans", sans-serif, "Meiryo";
	padding: 0 12px;
}

pre {
	background-color: #f8f8f8;
	border: 1px solid #cccccc;
	border-radius: 3px;
	overflow-x: auto;
	white-space: pre-wrap;
	overflow-wrap: break-word;
}

pre:not(.hljs) {
	padding: 23px;
	line-height: 19px;
}

blockquote {
	background: rgba(127, 127, 127, 0.1);
	border-color: rgba(0, 122, 204, 0.5);
}

.emoji {
	height: 1.4em;
}

code {
	font-size: 14px;
	line-height: 19px;
}

/* for inline code */
:not(pre):not(.hljs) > code {
	color: #C9AE75; /* Change the old color so it seems less like an error */
	font-size: inherit;
}

/* Page Break : use <div class="page"/> to insert page break
-------------------------------------------------------- */
.page {
	page-break-after: always;
}

</style>
<link rel="stylesheet" href="file:///Users/okmt/books/logicalbeat_md.css" type="text/css">
<script src="https://unpkg.com/mermaid/dist/mermaid.min.js"></script>
</head>
<body>
  <script>
    mermaid.initialize({
      startOnLoad: true,
      theme: document.body.classList.contains('vscode-dark') || document.body.classList.contains('vscode-high-contrast')
          ? 'dark'
          : 'default'
    });
  </script>
<h1 id="kubernetes">Kubernetes</h1>
<h2 id="container%E3%82%92%E5%8B%95%E3%81%8B%E3%81%99%E3%81%9F%E3%82%81%E3%81%AE%E3%83%AA%E3%82%BD%E3%83%BC%E3%82%B9">Containerを動かすためのリソース</h2>
<p>pod, replicaset, service, deployment</p>
<pre class="hljs"><code><div>$ kubectl get all
NAME                              READY   STATUS             RESTARTS      AGE
pod/backend-app-89b68f9fc-gj94v   1/1     Running            0             45h
pod/backend-app-89b68f9fc-mrbn2   1/1     Running            0             45h
pod/batch-app-28144040-wzh89      0/1     CrashLoopBackOff   3 (20s ago)   63s

NAME                          TYPE           CLUSTER-IP     EXTERNAL-IP                                                                  PORT(S)          AGE
service/backend-app-service   LoadBalancer   10.100.61.85   a159eb0af247f42e994342dab57d432a-47984927.ap-northeast-1.elb.amazonaws.com   8080:30893/TCP   45h

NAME                          READY   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/backend-app   2/2     2            2           46h

NAME                                    DESIRED   CURRENT   READY   AGE
replicaset.apps/backend-app-89b68f9fc   2         2         2       46h

NAME                      SCHEDULE      SUSPEND   ACTIVE   LAST SCHEDULE   AGE
cronjob.batch/batch-app   */5 * * * *   False     1        63s             17m

NAME                           COMPLETIONS   DURATION   AGE
job.batch/batch-app-28144035   0/1           6m3s       6m3s
job.batch/batch-app-28144040   0/1           63s        63s
</div></code></pre>
<p>Nginxコンテナを単体で動かす場合の設定ファイル</p>
<pre class="hljs"><code><div>apiVersion: v1 // マニフェストファイルの仕様のバージョン
kind: Pod // オブジェクトの種類
metadata:
  name: nginx-pod // Podの名前を指定
  labels:
    app: nginx-app // Podに対するラベル
spec:
  containers: // このPodに属するコンテナ
  - name: nginx-container
    image: nginx
    ports:
      - containerPort: 80 // コンテナが公開するポート
</div></code></pre>
<p>k8sにおけるラベルはリソースの識別に利用される</p>
<p>DeveopmentやServiceのマニフェストのselecter項目に対象とするPodのラベルを指定する</p>
<p>複数コンテナを含むPodは本書では利用していない</p>
<p>1つのPodに含まれるコンテナは</p>
<ul>
<li>お互いにlocalhostで通信できる</li>
<li>ストレージ（ボリューム）を共有できる</li>
</ul>
<p>これらのコンテナは必ずセットで起動・停止される</p>
<p>同時に利用される場合のデザインパターンは以下のようなものがある</p>
<ul>
<li>サイドカーパターン</li>
</ul>
<p><img src="./sidecar.png" alt="sidecar"></p>
<ul>
<li>アンバサダーパターン</li>
</ul>
<p><img src="./ambassador.png" alt="ambassador"></p>
<p>デザインパターンの記事: https://qiita.com/MahoTakara/items/03fc0afe29379026c1f3</p>
<p>Pod初期化用コンテナは以下の利用目的</p>
<ul>
<li>アプリケーション本体では必要ないツールを用いて初期化処理を行う</li>
<li>同梱するとメインコンテナのセキュリティを低下させてしまうツールを用いて初期化処理を行うことができる</li>
<li>初期化処理とアプリケーション本体を独立してビルド・デプロイができる</li>
</ul>
<p>APIアプリケーションの場合、Deploymentがk8sクラスターに登録されると、
ReplicaSetが作られ、ResplicaSetからPodが作られ、Podの中でコンテナが動くという仕組みになっている</p>
<h2 id="pod%E3%81%AE%E5%A4%9A%E9%87%8D%E5%8C%96%E3%82%84%E3%83%90%E3%83%BC%E3%82%B8%E3%83%A7%E3%83%B3%E3%82%A2%E3%83%83%E3%83%97%E3%83%BB%E3%83%AD%E3%83%BC%E3%83%AB%E3%83%90%E3%83%83%E3%82%AF%E3%82%92%E5%AE%9F%E7%8F%BE%E3%81%99%E3%82%8Bdeployment">Podの多重化やバージョンアップ・ロールバックを実現するDeployment</h2>
<p>Podを用いればk8s cluster上でプログラムを動かせるが、ウェブアプリケーションを動かす場合はPodを直接デプロイすることはそうない</p>
<p>通常直接PodをデプロイしないでDevelopmentというオブジェクトを作り、間接的にPodをデプロイする</p>
<p>Deploymentを用いてアプリケーションをデプロイすると有効Pod数を維持するようにPodを自動で増減してくれる</p>
<p>Delopoymentを利用することで直接Podをデプロイしたのでは実現できない様々な非機能的な処理をk8sの仕組みで行うことができる</p>
<p><img src="./deployment2.png" alt="deployment2"></p>
<pre class="hljs"><code><div>apiVersion: apps/v1 // マニフェストファイルのバージョン
kind: Deployment // オブジェクトの種類
metadata:
  name: backend-app // Deploymentの名前を指定
  labels:
    app: backend-app // Deploymentに対するラベル
spec:
  replicas: 2 // Deploymentを通じてクラスター内にデプロイされるPodの数を指定
  selector: / selecterのmatchLabelsはラベルと同様のものを指定
    matchLabels:
      app: backend-app
  template: // Deploymentを通じてデプロイするPodの定義
    metadata:
      labels:
        app: backend-app // ラベル名
    spec:
      containers:
        - name: backend-app // コンテナ名
          image: 761624429622.dkr.ecr.ap-northeast-1.amazonaws.com/k8sbook/backend-app:1.1.0 // コンテナイメージ名
          imagePullPolicy: Always
          ports:
          - containerPort: 8080 // コンテナが公開するポートを指定
          env: // 本Podで仕様する環境変数をSecretというオブジェクトを用いて設定するための記述
            - name: DB_URL
              valueFrom:
                secretKeyRef:
                  key: db-url
                  name: db-config
            - name: DB_USERNAME
              valueFrom:
                secretKeyRef:
                  key: db-username
                  name: db-config
            - name: DB_PASSWORD
              valueFrom:
                secretKeyRef:
                  key: db-password
                  name: db-config
          readinessProbe: // コンテナが起動したか、正常動作しているかをチェックする仕組み
            httpGet:
              port: 8080
              path: /health
            initialDelaySeconds: 15
            periodSeconds: 30
          livenessProbe: // コンテナが起動したか、正常動作しているかをチェックする仕組み
            httpGet:
              port: 8080
              path: /health
            initialDelaySeconds: 30
            periodSeconds: 30
          resources: // Podが仕様するメモリやCPUなどのリソース量についての定義
            requests:
              cpu: 100m
              memory: 512Mi
            limits:
              cpu: 250m
              memory: 768Mi
          lifecycle:
            preStop:
              exec:
                command: [&quot;/bin/sh&quot;, &quot;-c&quot;, &quot;sleep 2&quot;]
</div></code></pre>
<p>Deploymentが直接Podをデプロイするわけではなく、その間にReplicaSetという別のオブジェクトが作成されている</p>
<p>Pod数の増減やPod障害時の自動再起動を実質的に実行しているのはReplicaSet</p>
<pre class="hljs"><code><div>$ kubectl get deployment
NAME          READY   UP-TO-DATE   AVAILABLE   AGE
backend-app   2/2     2            2           2d9h
$ kubectl get replicaset
NAME                    DESIRED   CURRENT   READY   AGE
backend-app-89b68f9fc   2         2         2       2d9h
$ kubectl get pod
NAME                          READY   STATUS    RESTARTS   AGE
backend-app-89b68f9fc-gj94v   1/1     Running   0          2d9h
backend-app-89b68f9fc-mrbn2   1/1     Running   0          2d9h
</div></code></pre>
<p>kubectl describeコマンドで詳細情報を取得する場合は以下のコマンドを使う</p>
<pre class="hljs"><code><div>$ kubectl describe リソース種別名 オブジェクト名
</div></code></pre>
<pre class="hljs"><code><div>$ kubectl describe pod backend-app-89b68f9fc-gj94v
Name:             backend-app-89b68f9fc-gj94v // Podの名称
Namespace:        eks-work // Podが作成されているNamespace名
Priority:         0
Service Account:  default
Node:             ip-192-168-1-107.ap-northeast-1.compute.internal/192.168.1.107 // Podが配置されているノード名
Start Time:       Tue, 04 Jul 2023 22:37:53 +0900 //  Podの起動日時
Labels:           app=backend-app // Deploymentの記載したラベル
                  pod-template-hash=89b68f9fc
Annotations:      &lt;none&gt;
Status:           Running // Podのステータス
IP:               192.168.1.99 // Podに割り当てられたIPアドレス
IPs:
  IP:           192.168.1.99
Controlled By:  ReplicaSet/backend-app-89b68f9fc // Podを制御している上位オブジェクト
Containers: // コンテナ単位の状態
  backend-app:
    Container ID:   containerd://018718715bfc2efbbd7e38b98da5df257e0ac8522997e117eca8cb5b0a64d4c0
    Image:          761624429622.dkr.ecr.ap-northeast-1.amazonaws.com/k8sbook/backend-app:1.1.0 // コンテナイメージ名
    Image ID:       761624429622.dkr.ecr.ap-northeast-1.amazonaws.com/k8sbook/backend-app@sha256:23184d18681afb6957d5699c21c9d22683cacd7d1201c2091b79f13e711ad436
    Port:           8080/TCP // コンテナが使用するプロトコルとポート番号
    Host Port:      0/TCP
    State:          Running
      Started:      Tue, 04 Jul 2023 22:37:54 +0900
    Ready:          True
    Restart Count:  0
    Limits: // リソース制限
      cpu:     250m
      memory:  768Mi
    Requests: // リソース制限
      cpu:      100m
      memory:   512Mi
    Liveness:   http-get http://:8080/health delay=30s timeout=1s period=30s #success=1 #failure=3 // Podのヘルスチェック Liveness Probe
    Readiness:  http-get http://:8080/health delay=15s timeout=1s period=30s #success=1 #failure=3 // Podのヘルスチェック Readiness Probe
    Environment: // k8sによってこのPodに設定されている環境変数。これはdb-configというsecretから割り当てられている
      DB_URL:       &lt;set to the key 'db-url' in secret 'db-config'&gt;       Optional: false
      DB_USERNAME:  &lt;set to the key 'db-username' in secret 'db-config'&gt;  Optional: false
      DB_PASSWORD:  &lt;set to the key 'db-password' in secret 'db-config'&gt;  Optional: false
    Mounts:
      /var/run/secrets/kubernetes.io/serviceaccount from kube-api-access-b4j9l (ro)
Conditions:
  Type              Status
  Initialized       True 
  Ready             True 
  ContainersReady   True 
  PodScheduled      True 
Volumes: // マウントされているボリュームの情報
  kube-api-access-b4j9l:
    Type:                    Projected (a volume that contains injected data from multiple sources)
    TokenExpirationSeconds:  3607
    ConfigMapName:           kube-root-ca.crt
    ConfigMapOptional:       &lt;nil&gt;
    DownwardAPI:             true
QoS Class:                   Burstable
Node-Selectors:              &lt;none&gt;
Tolerations:                 node.kubernetes.io/not-ready:NoExecute op=Exists for 300s
                             node.kubernetes.io/unreachable:NoExecute op=Exists for 300s
Events:                      &lt;none&gt;
</div></code></pre>
<h2 id="cronjob%E3%81%AB%E3%82%88%E3%82%8B%E3%82%B9%E3%82%B1%E3%82%B8%E3%83%A5%E3%83%BC%E3%83%AB%E8%B5%B7%E5%8B%95">CronJobによるスケジュール起動</h2>
<p>CronJobはk8s上でプログラムを時刻あるいは時間間隔を指定して起動するための仕組み</p>
<pre class="hljs"><code><div>apiVersion: batch/v1 // CronJobに対するAPIバージョン
kind: CronJob // リソース種別
metadata:
  name: batch-app // CronJobの名前
spec:
  schedule: &quot;*/5 * * * *&quot; # min hour day-of-month month day-of-week // スケジュール定義
  jobTemplate: // jobの定義
    spec:
      template:
        spec:
          containers:
            - name: batch-app // コンテナの名前
              image: ${ECR_HOST}/k8sbook/batch-app:1.0.0 // イメージ
              imagePullPolicy: Always
              env: // 複数のSecret及びConfigMapから値を取得する
                - name: DB_URL
                  valueFrom:
                    secretKeyRef:
                      key: db-url
                      name: db-config
                - name: DB_USERNAME
                  valueFrom:
                    secretKeyRef:
                      key: db-username
                      name: db-config
                - name: DB_PASSWORD
                  valueFrom:
                    secretKeyRef:
                      key: db-password
                      name: db-config
                - name: CLOUD_AWS_CREDENTIALS_ACCESSKEY
                  valueFrom:
                    secretKeyRef:
                      key: aws-accesskey
                      name: batch-secret-config
                - name: CLOUD_AWS_CREDENTIALS_SECRETKEY
                  valueFrom:
                    secretKeyRef:
                      key: aws-secretkey
                      name: batch-secret-config
                - name: CLOUD_AWS_REGION_STATIC
                  valueFrom:
                    configMapKeyRef:
                      key: aws-region
                      name: batch-app-config
                - name: SAMPLE_APP_BATCH_BUCKET_NAME
                  valueFrom:
                    configMapKeyRef:
                      key: bucket-name
                      name: batch-app-config
                - name: SAMPLE_APP_BATCH_FOLDER_NAME
                  valueFrom:
                    configMapKeyRef:
                      key: folder-name
                      name: batch-app-config
                - name: SAMPLE_APP_BATCH_RUN
                  valueFrom:
                    configMapKeyRef:
                      key: batch-run
                      name: batch-app-config
          restartPolicy: OnFailure
</div></code></pre>
<p>CronJobをk8sクラスターに登録して指定した実行時刻が来ると内部的にJobというリソースが作られ、Jobの中でPodが作られる</p>
<p>CronJobの場合、CronJob -&gt; Job -&gt; Podという流れで作られていく</p>
<p><img src="./cronjob.avif" alt="cronjob"></p>
<p>CronJob、Job、Podのそれぞれの守備範囲をはっきりさせておく</p>
<ul>
<li>Cronフォーマットによる時間の管理</li>
<li>重複するジョブの制御など(詳細は後ほど)</li>
<li>Jobのステータス管理</li>
<li>Jobが正常に完了したかどうかをモニタリング</li>
<li>過去履歴の保持(成功/失敗それぞれ)</li>
</ul>
<p>Job</p>
<ul>
<li>Podのコンフィグ管理</li>
<li>Podのステータス管理</li>
<li>失敗時のリトライ有無</li>
<li>失敗時のタイムアウト時間</li>
<li>並行実行数</li>
<li>&quot;成功&quot;と判定するために必要な完了数</li>
</ul>
<p>Pod</p>
<ul>
<li>Jobが持つPodのコンフィグを継承、任意のイメージで任意のジョブを実行する(Deploymentのように継続実行ではなく、ジョブを終えるとexitすることが期待される)</li>
</ul>
<h2 id="job%E3%83%AA%E3%82%BD%E3%83%BC%E3%82%B9%E3%81%AE%E6%8C%AF%E3%82%8B%E8%88%9E%E3%81%84">Jobリソースの振る舞い</h2>
<p>Jobとは一定の処理を行なって完了するタスクを実行するためのリソース</p>
<p>設定内容によっては複数の処理を並行起動することができる</p>
<p>ジョブの実行数を規定するパラメータには .spec.completions .spec.parallelism がある</p>
<p>ジョブの実行パターン</p>
<ol>
<li>単一のPodを実行する実行パターン</li>
<li>完了すべきPodの数を指定する実行パターン</li>
<li>ワークキュー型の実行パターン</li>
</ol>
<p>それぞれ.spec.completions .spec.parallelismのパラメータを適切に設定することで実装可能</p>
<p>ジョブのリトライ回数はパラメータは.spec.backoffLimitでデフォルト6</p>
<p>同時実行制御のパラメータは.spec.concurrencyPolicyはでデフォルトは1の「Allow」</p>
<p>k8sドキュメントCron Job Limitationsには以下の記述がある</p>
<p>https://kubernetes.io/docs/concepts/workloads/controllers/cron-jobs/</p>
<pre class="hljs"><code><div>基本的にはCronJobからは1つの実行タイミングに1つのJobオブジェクトが作成されるものの、
稀ではあるが、CronJobオブジェクトから複数のJobオブジェクトが作成されることがあるため、ジョブは冪等性を持つように作成すべき
</div></code></pre>
<h2 id="%E5%90%84%E3%83%8E%E3%83%BC%E3%83%89%E3%81%AB%E5%BF%85%E3%81%9A%EF%BC%91%E3%81%A4pod%E3%82%92%E7%AB%8B%E3%81%A1%E4%B8%8A%E3%81%92%E3%82%8Bdaemonset">各ノードに必ず１つPodを立ち上げるDaemonSet</h2>
<p>k8sクラスターにDaemonSetを登録すると、
その中で定義されたPodがクラスターに所属しているワーカーのーどごとに一つずつ起動される</p>
<p>DaemonSetのユースケースとしてはログ収集用のエージェントを各ノードで立ち上げるというものがある</p>
<h2 id="%E6%B0%B8%E7%B6%9A%E5%8C%96%E3%83%87%E3%83%BC%E3%82%BF%E3%82%92%E6%89%B1%E3%81%86%E3%81%9F%E3%82%81%E3%81%AEstatefulset">永続化データを扱うためのStatefulSet</h2>
<p>ReplicaSetを使うことでPodが異常終了した場合でも自動的にPodを再起動したり他のノードに再作成したりして
所定のPod数を維持できる仕組みになっている</p>
<p>つまりReplicaSetからPodが再作成される場合、そのPodは毎回初期状態で起動される</p>
<p>ただし、コンテナが初期状態になるとデータベースのように保持しているデータまで初期化されるのは困る</p>
<p>Podの外にVolumeという形でデータを保持し、Podが再起動された場合でもそれまで使っていたVolumeを引き継ぐ仕組みがStatefulSet</p>
<p>StatefulSetとはk8sがステートフルな状態をもつために必要</p>
<p>Namespaceはコンテナを動かす環境であるクラスターを論理的に分割して管理・運用するためのリソース</p>
<p>k8sでは標準で</p>
<ul>
<li>default: 明示的にNamespaceを指定しなかった場合に使用されるNamespace</li>
<li>kube-system: k9sによって作られるオブジェクトが利用するNamespace</li>
<li>kube-public: 未認証ユーザを含むすべてのユーザから参照できるNamespace</li>
</ul>
<p>の3つのNamespaceが存在すると定義されている</p>
<p>Namespaceは単にリソースをハンチする論理的な区分だけでなくResouceQuoraやNetworkPolicyといった仕組みと併用することで、
リソース使用量やネットワーク通信の制限などを行うことができる</p>
<h2 id="namespace%E3%82%92%E5%AE%9A%E7%BE%A9%E3%81%99%E3%82%8B%E3%83%9E%E3%83%8B%E3%83%95%E3%82%A7%E3%82%B9%E3%83%88%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB">Namespaceを定義するマニフェストファイル</h2>
<p>Namespaceの作成</p>
<pre class="hljs"><code><div>apiVersion: v1
kind: Namespace // リソースの種別
metadata:
  name: eks-work // 作成するNamespaceの名前
</div></code></pre>
<p>※　Deploymentの更新とロールバック</p>
<h2 id="%E3%82%B3%E3%83%B3%E3%83%86%E3%83%8A%E3%82%92%E5%85%AC%E9%96%8B%E3%81%99%E3%82%8B%E3%81%9F%E3%82%81%E3%81%AE%E3%83%AA%E3%82%BD%E3%83%BC%E3%82%B9">コンテナを公開するためのリソース</h2>
<p>複数のPodをServiceで束ねることで単一のDNSでアクセスできるようになる</p>
<p>Serviceを用いていることで正常に稼働しているPodにリクエストを振り分けることができる</p>
<pre class="hljs"><code><div>apiVersion: v1 // Serviceリソースのバージョン
kind: Service // リソース種別
metadata:
  name: backend-app-service // Serviceリソースの名前
spec:
  type: LoadBalancer // Serviceの種類
  selector:
    app: backend-app // Serviceが対象するPodを選択するためのセレクター定義
  ports: // サービスにサクセスするためのプロトコルとポート割り当て
    - protocol: TCP
      port: 8080
      targetPort: 8080
</div></code></pre>
<p><a href="https://ameblo.jp/bakery-diary/entry-12614040050.html">Serviceの種類</a></p>
<ul>
<li>ClusterIP</li>
<li>NodePort</li>
<li>LoadBalancer</li>
<li>ExternalName</li>
</ul>
<p>LoadBalancerはクラスター外にロードバランサーが作成される</p>
<p>クラウドプロバイダーによるがAWSのEKSの場合はELBのロードバランサー（CLB/NLB）が作成される</p>
<p><img src="./loadbalancer.png" alt="loadbalancer"></p>
<h2 id="%E8%A8%AD%E5%AE%9A%E6%83%85%E5%A0%B1%E3%81%AA%E3%81%A9%E3%82%92%E5%AE%89%E5%85%A8%E3%81%AB%E6%B3%A8%E5%85%A5%E3%81%99%E3%82%8B%E4%BB%95%E7%B5%84%E3%81%BF">設定情報などを安全に注入する仕組み</h2>
<p>~</p>
<h2 id="pod%E3%82%92%E5%AE%89%E5%85%A8%E3%81%AB%E5%81%9C%E6%AD%A2%E3%81%99%E3%82%8B%E3%81%9F%E3%82%81%E3%81%AE%E8%80%83%E6%85%AE">Podを安全に停止するための考慮</h2>
<p>~</p>
<h2 id="%E3%83%AA%E3%82%BD%E3%83%BC%E3%82%B9%E3%83%9E%E3%83%8D%E3%82%B8%E3%83%A1%E3%83%B3%E3%83%88">リソースマネジメント</h2>
<p>~</p>
<p>~</p>

</body>
</html>
